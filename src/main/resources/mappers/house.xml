<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- name space는 AreaRepository의 fully qualified name으로 설정한다. -->
<mapper namespace="com.ssafy.happyhouse.repository.HouseRepository">

	<resultMap type="com.ssafy.happyhouse.model.area.Upmyundong" id="Upmyundong">
		<result column="name" property="name"/>
		<result column="code" property="code"/>
		<result column="lat" property="lat"/>
		<result column="lng" property="lng"/>
	</resultMap>

	<resultMap type="com.ssafy.happyhouse.model.house.HouseInfo" id="HouseInfo">
		<result column="aptName" property="aptName" />
		<result column="buildYear" property="buildYear" />
		<result column="jibun" property="jibun" />
		<collection property="upmyundong" resultMap="Upmyundong" />
	</resultMap>
	
	<resultMap type="com.ssafy.happyhouse.model.house.DealInfo" id="DealInfo">
		<result column="id" property="id"/>
		<result column="type" property="type"/>
		<result column="floor" property="floor"/>
		<result column="price" property="price"/>
		<result column="exclusivePrivateArea" property="exclusivePrivateArea"/>
		<result column="dealYear" property="dealYear"/>
		<result column="dealMonth" property="dealMonth"/>
		<result column="dealDay" property="dealDay"/>
		<collection property="houseInfo" resultMap="HouseInfo" />
	</resultMap>

	<select id="findAllHouses" resultMap="HouseInfo">
		SELECT h.aptName, h.buildYear, h.jibun, h.upmyundong_name, h.upmyundong_code,
			   u.name, u.code, u.lat, u.lng, u.sigugun_id
		FROM HouseInfo as h
		JOIN Upmyundong as u
		ON h.upmyundong_code = u.code and h.upmyundong_name = u.name
	</select>

	<insert id="insertBatchHouse"
	parameterType="com.ssafy.happyhouse.model.house.HouseInfo"
	useGeneratedKeys="true" keyProperty="id">
		INSERT INTO HouseInfo(aptName, buildYear, jibun, upmyundong_name, upmyundong_code) VALUES
		<foreach collection="collection" item="house" separator=",">
			(#{house.aptName}, #{house.buildYear}, #{house.jibun}, #{house.upmyundong.name}, #{house.upmyundong.code})
		</foreach>
	</insert>
	
	<insert id="insertBatchDeal"
	parameterType="com.ssafy.happyhouse.model.house.DealInfo"
	useGeneratedKeys="true" keyProperty="id">
		INSERT INTO DealInfo(type, floor, price, exclusivePrivateArea, 
			dealYear, dealMonth, dealDay, houseInfo_aptName, houseInfo_upmyundong_name) 
		VALUES
		<foreach collection="collection" item="deal" separator=",">
			(#{deal.type}, #{deal.floor}, #{deal.price}, #{deal.exclusivePrivateArea}, 
			#{deal.dealYear}, #{deal.dealMonth}, #{deal.dealDay}, 
			#{deal.houseInfo.aptName}, #{deal.houseInfo.upmyundong.name})
		</foreach>
	</insert>
	
	<select id="findByAreaCodeDate" parameterType="String" resultMap="DealInfo">
		SELECT hi.aptName, hi.buildYear, hi.jibun,
		       di.id, di.type, di.floor, di.price, di.exclusivePrivateArea,
			   di.dealYear, di.dealMonth, di.dealDay,
			   umd.name, umd.code, umd.lat, umd.lng
		FROM houseInfo as hi
		JOIN DealInfo as di
		ON hi.aptName = di.houseInfo_aptName and hi.upmyundong_name = di.houseInfo_upmyundong_name
		JOIN upmyundong as umd
		ON umd.name = hi.upmyundong_name and umd.code = hi.upmyundong_code
		WHERE umd.code = ${code} and di.dealYear = #{dealYear} and di.dealMonth = #{dealMonth}
	</select>
</mapper>

